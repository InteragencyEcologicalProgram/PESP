# Format EMP Phytoplankton Data

**Purpose:** Code to format and append new EMP phytoplankton data to the current EDI data set.

**Author:** Sarah Perry ([sarah.perry\@water.ca.gov](mailto:sarah.perry@water.ca.gov){.email})

**Date Edited:** 07/20/2023

THIS DOCUMENT IS STILL IN PROGRESS
(will be an html file at the end)

## Variables to Edit

```{r}
# specify the file path of the new data (as a csv)
data_path <- 'EMP/Phyto Data 2008-present_012723.csv'
```

## Formatting Code (Don't Edit)

Hit the green arrow on the right side of the code to run.

**Output:** a .csv containing the formatted data (ready for EDI publication)

If errors occur, contact Sarah Perry.

```{r}
# Import Packages ---------------------------------------------------------
library(tidyverse)
library(fuzzyjoin)
library(lubridate)
source('01_global_functions/global_funcs.R')
source('01_global_functions/bsa_funcs.R')

# create object "not in" for logic purposes
'%!in%' <- function(x,y)!('%in%'(x,y))

# Read in Data ------------------------------------------------------------
# data frame containing Tiffany Browns's standardized phyto taxa csv
df_syn <- read_csv('01_global_data/phyto_classification.csv', show_col_types = FALSE)

# new data to format and append
df_data <- read_csv(data_path, show_col_types = FALSE)

# # remove unnecessary columns/rename
# df_data <- df_data %>%
#   select(-c(Taxonomist, LabNumber, TIN, SynonymOrig))

# remove percents from percent col, fix dates/times, colony codes
df_data$Percent_Sample_Counted <- gsub('%','',df_data$Percent_Sample_Counted)
df_data$Colony_or_FilamentGroupCode[df_data$Colony_or_FilamentGroupCode == 'n/p'] <- NA_character_
df_data$SampleDate <- as.Date(df_data$SampleDate, format = '%m/%d/%Y')
df_data <- df_data %>%
  mutate(
    SampleTime = case_when(grepl(':', SampleTime) ~ SampleTime,
                           is.na(SampleTime) ~ NA_character_,
                           TRUE ~ paste0(substr(SampleTime, 1, nchar(SampleTime)-2),':',substr(SampleTime, nchar(SampleTime)-1, nchar(SampleTime)))
                           )
    )

# Standardize Data Set ------------------------------------------------------------
# standardize column names
df_data <- df_data %>%
  mutate(
    StationCode = case_when(StationCode == 'C3A-Hood' | StationCode == 'C3A - Hood' | StationCode == 'C3A Hood' ~ 'C3A',
                            StationCode == 'D16 - Twitchell' | StationCode == 'D16-Twitchell' |StationCode == 'D16 Twitchell' ~ 'D16',
                            StationCode == 'E22' ~ 'EZ2',
                            StationCode == 'E26' ~ 'EZ6',
                            StationCode == 'EZ2 SJR' | StationCode == 'EZ2 - SJR' ~ 'EZ2-SJR',
                            StationCode == 'EZ6 SJR' | StationCode == 'EZ6 - SJR' ~ 'EZ6-SJR',
                            TRUE ~ StationCode)
    )

# standardize "unknown" identifiers
df_data <- func_unknowns(df_data)

# Add in Higher Level Taxa ------------------------------------------------------------
# subset synonym/taxon columns
df_syn <- df_syn %>% select(c('Kingdom':'AlgalGroup','Taxon','CurrentTaxon'))

# standardize spp. to sp.
df_data$Taxon <- str_replace_all(df_data$Taxon, 'spp.', 'sp.')
df_data$Species <- str_replace_all(df_data$Species, 'spp.', 'sp.')

# standardize unknown names before synonym join
# TODO: base this on a csv (for easier editing)
df_data <- df_data %>%
  mutate(
    Taxon = case_when(Taxon == 'LGBs' ~ 'Little Green Balls',
                     Taxon == 'Unknown Banana Blue Green' | Taxon == 'Unknown Cyanobacteria sp.' ~ 'Unknown cyanobacterium',
                     Taxon == 'Unknown centrales sp.' | Taxon == 'Unknown centric sp.' | Taxon == 'Unknown Centric diatom'  ~ 'Unknown centric diatom',
                     Taxon == 'Unknown Chlorophyte alga sp.' | Taxon == 'Unknown Chlorophyte filament' ~ 'Unknown green alga',
                     Taxon == 'Unknown dinoflagellate sp.' | Taxon == 'Unknown Dinoflagellate sp.' | Taxon == 'small dinoflagellates'~ 'Unknown dinoflagellate',
                     Taxon == 'Unknown girdle sp.' | Taxon == 'Unknown pennales sp.' | Taxon == 'Unknown pennate girdle sp.' ~ 'Unknown pennate diatom',
                     Taxon == 'Small nano-flagellates' | Taxon == 'small nano-flagellates' ~ 'Unknown nanoflagellate',
                     Taxon == 'Unknown Euglenoids' ~ 'Unknown euglenoid',
                     Taxon == 'Unknown Genus' ~ 'Unknown genus',
                     Taxon == 'Unknown Algae' ~ 'Unknown',
                     TRUE ~ Taxon)
    )

# join with main dataset
df_joined <- df_data %>%
  left_join(df_syn, by = 'Taxon') %>%
  select(-c(ends_with('.y'), ends_with('.x'))) %>%
  relocate(c(Taxon, Kingdom:AlgalGroup), .after = StationCode) %>%
  relocate(c(Genus, Species), .after = AlgalGroup)

# Update Names ------------------------------------------------------------
# TODO: turn into functions
# TODO: auto-check for multi-generation name changes
df_joined <- df_joined %>%
  mutate(
    Genus = case_when(Taxon == CurrentTaxon | grepl('None|Unknown',CurrentTaxon) | is.na(CurrentTaxon) ~ Genus,
                      TRUE ~ str_remove(str_squish(str_remove(CurrentTaxon, 'cf.')), ' .*')),
    Species = case_when(Taxon == CurrentTaxon | grepl('None|Unknown',CurrentTaxon) | is.na(CurrentTaxon) ~ Species,
                        TRUE ~ str_remove(str_squish(str_remove(CurrentTaxon, 'cf.')), '.*? ')),
    OrigTaxon = case_when(Taxon == CurrentTaxon | grepl('None|Unknown',CurrentTaxon) | is.na(CurrentTaxon) ~ NA_character_,
                         TRUE ~ Taxon),
    Taxon = case_when(grepl('None|Unknown',CurrentTaxon) | is.na(CurrentTaxon) ~ Taxon,
                      TRUE ~ CurrentTaxon
                      )) %>%
  select(-CurrentTaxon) %>%
  relocate(OrigTaxon, .after = StationCode)

# standardize specific unknown Taxon cases
df_joined <- df_joined %>%
  mutate(
    AlgalGroup = case_when(Taxon == 'Little Green Balls' ~ 'Unknown',
                           Taxon == 'Unknown cyanobacteria' ~ 'Cyanobacteria',
                           Taxon == 'Unknown centric diatom' ~ 'Centric Diatoms',
                           Taxon == 'Unknown green alga' ~ 'Green Algae',
                           Taxon == 'Unknown dinoflagellate' ~ 'Dinoflagellates',
                           Taxon == 'Unknown pennate diatom' ~ 'Pennate Diatoms',
                           Taxon == 'Unknown nanoflagellate' ~ 'Nanflagellates',
                           Taxon == 'Unknown euglenoid' ~ 'Euglenoids',
                           TRUE ~ AlgalGroup)
  )

# Check Taxa for Errors ------------------------------------------------------------
df_error_check <- df_joined %>% select(c('Taxon':'Species'))

check <- df_error_check %>% subset(is.na(AlgalGroup) | is.na(Class) | is.na(Phylum) | is.na(Kingdom) | is.na(Genus) | is.na(Species))
check <- check[!duplicated(check),]
check <- check %>% arrange(Taxon)
syn_check <- df_error_check %>% subset(is.na(Taxon) | Taxon == 'Unknown')
syn_check <- syn_check[!duplicated(syn_check),]
syn_check <- syn_check %>% arrange(Taxon)

print(check)
print(syn_check)
```

## Clean Data

### Average Biovolume, Biovolume Density

```{r}
df_joined$Total_Cells_Counted <- as.numeric(df_joined$Total_Cells_Counted)

df_joined <- df_joined %>%
  mutate(Cells_per_mL =
    case_when(
      Lab == 'EcoAnalysts' ~ Organisms_per_mL*Cells_per_Unit,
      Lab == 'BSA' ~ Total_Cells_Counted*Factor)
  )

df_joined <- df_joined %>%
  mutate(AverageBiovolume = round(rowMeans(select(., starts_with('Biovolume')), na.rm = TRUE),2),
         AverageBiovolume_per_mL = round(AverageBiovolume*Factor*Total_Cells_Counted,2)) %>% # Counted'
  select(-starts_with('Biovolume_')) %>%
  relocate(Comments, .after = Shape) %>%
  relocate(AverageBiovolume:AverageBiovolume_per_mL, .after = Organisms_per_mL)

df_joined$AverageBiovolume[is.nan(df_joined$AverageBiovolume)] <- NA
df_joined$AverageBiovolume_per_mL[is.nan(df_joined$AverageBiovolume_per_mL)] <- NA
```

### Change Comments to QA

```{r}
df_joined <- df_joined %>%
  mutate(
    QC_1 = case_when(grepl('broken\\.|cannot meet|did not reach|delete', Comments, ignore.case = TRUE) ~ 'BadData'),
    QC_2 = case_when(grepl('degraded', Comments, ignore.case = TRUE) ~ 'Degraded'),
    QC_3 = case_when(grepl('poorly preserved', Comments, ignore.case = TRUE) ~ 'PoorlyPreserved'),
    QC_4 = case_when(grepl('fragment\\.', Comments, ignore.case = TRUE) ~ 'Fragmented')
  ) %>%
  unite(QualityCheck, starts_with('QC'), remove = TRUE, na.rm = TRUE, sep = ' ')

df_joined$QualityCheck[df_joined$QualityCheck == ''] <- 'Good'
```

### Remove Columns and Duplicates

```{r}
df_joined <- df_joined %>%
  select(-c(VolumeReceived:UnitAbundance, Cells_per_Unit, Total_Cells_Counted, Comments))

df_joined <- distinct(df_joined)
df_joined <- df_joined[!duplicated(df_joined),]
```

## Export

```{r}
write_csv(df_joined,'03_Phyto/PESP/data/EMP/EMP_Phyto_Data_2008-2021_CELLSADDITION063023.csv')
```

