# Check for BSA Issue (BGC)

**Purpose:** Code to check if BGC has the BSA issue

**Author:** Perry ([sarah.perry\@water.ca.gov](mailto:sarah.perry@water.ca.gov){.email})

```{r}
library(tidyverse)
library(vegan)
library(lubridate)
source('admin/global_functions/global_funcs.R')
source('admin/global_functions/check_funcs.R')
```

```{r}
df_phyto <- read_quiet_csv(abs_pesp_path('Groups/USGS-BGC/02 Processed Data/BGC_draft.csv')) %>%
  mutate(Year = year(Date)) %>%
  mutate(StationYear = paste(Year, Station, sep = ' '))

# create NMDS
df_nmds1 <- create_nmds(df_phyto,
                       group_var = 'Year',
                       nmds_var = 'Cells_per_mL',
                       taxa_var = 'AlgalGroup')

# print dataframe
df_nmds1[[1]]

# print graph
df_nmds1[[2]]

ggsave(
  filename = abs_pesp_path('Groups/USGS-BGC/02 Processed Data/QC files/graphs/BGC_NMDS_CellspermL_Year.jpg'),
  plot = df_nmds1[[2]],
  width = 8,
  height = 6
)
```

```{r}
# create NMDS
df_nmds2 <- create_nmds(df_phyto,
                        group_var = 'Date',
                        nmds_var = 'Cells_per_mL',
                        taxa_var = 'AlgalGroup',
                        factor_var = 'Year')

# print dataframe
df_nmds2[[1]]

# print graph
df_nmds2[[2]]

ggsave(
  filename = abs_pesp_path('Groups/USGS-BGC/02 Processed Data/QC files/graphs/BGC_NMDS_CellspermL_Date.jpg'),
  plot = df_nmds2[[2]],
  width = 8,
  height = 6
)
```
Data looks odd.

Methods?

```{r}
df_phyto %>%
  count(Year, SampleMethod) %>%
  arrange(Year, SampleMethod) %>%
  group_by(Year) %>%
  summarise(SampleMethods = paste0('  â€¢ ', SampleMethod, ' (', n, ')', collapse = '\n')) %>%
  mutate(Summary = paste0('Year ', Year, ':\n', SampleMethods)) %>%
  pull(Summary) %>%
  cat(sep = '\n\n')
```
```{r}
library(ggrepel)
library(sf)

base_map <- map_data('state') %>%
  filter(region == 'california')

df_phyto %>%
  group_by(Station, Longitude, Latitude) %>%
  ggplot(aes(x = Longitude, y = Latitude)) +
  geom_polygon(data = base_map, aes(x = long, y = lat, group = group),
               fill = 'gray90', color = 'gray50', linewidth = 0.2, inherit.aes = FALSE) +
  geom_point(color = 'blue', size = 1) +
  # geom_text_repel(aes(label = Station), size = 3, max.overlaps = 10) +
  coord_sf(xlim = c(-122.7, -121.2), ylim = c(37.35, 38.65)) +
  facet_wrap(~ Year) +
  labs(title = 'Station Locations by Year',
       x = 'Longitude',
       y = 'Latitude') +
  theme_minimal()
```

```{r}
# Find all Taxa present in 2016 or 2017
valid_taxa <- df_phyto %>%
  filter(Year %in% c(2016, 2017,2018)) %>%
  pull(Station) %>%
  unique()

# Filter the main dataframe
df_phyto_filtered <- df_phyto %>%
  filter(Year > 2018 & Station %in% valid_taxa | Year <= 2018)
```

```{r}
# create NMDS
df_nmds3 <- create_nmds(df_phyto_filtered,
                        group_var = 'Date',
                        nmds_var = 'Cells_per_mL',
                        factor_var = 'Year')

# print dataframe
df_nmds3[[1]]

# print graph
df_nmds3[[2]]

# ggsave(
#   filename = abs_pesp_path('Groups/USGS-BGC/02 Processed Data/QC files/graphs/BGC_NMDS_CellspermL_Date.jpg'),
#   plot = df_nmds2[[2]],
#   width = 8,
#   height = 6
# )
```

```{r}
# Find all Taxa present in 2016 or 2017
valid_taxa <- df_phyto %>%
  filter(Year %in% c(2016, 2017,2018)) %>%
  pull(Taxon) %>%
  unique()

# Find all Stations present in 2016 or 2017
valid_stations <- df_phyto %>%
  filter(Year %in% c(2016, 2017,2018)) %>%
  pull(Station) %>%
  unique()

# Filter the main dataframe
df_phyto_filtered <- df_phyto %>%
  filter(
    (Year > 2018 & Taxon %in% valid_taxa & Station %in% valid_stations) |
    (Year <= 2018)
  )

df_phyto_filtered_stationonly <- df_phyto %>%
  filter(
    (Year > 2018 & Station %in% valid_stations) |
    (Year <= 2018)
  )
```

```{r}
# create NMDS
df_nmds4 <- create_nmds(df_phyto_filtered,
                        group_var = 'Date',
                        nmds_var = 'Cells_per_mL',
                        taxa_var = 'AlgalGroup',
                        factor_var = 'Year')

# print dataframe
df_nmds4[[1]]

# print graph
df_nmds4[[2]]

# ggsave(
#   filename = abs_pesp_path('Groups/USGS-BGC/02 Processed Data/QC files/graphs/BGC_NMDS_CellspermL_Date.jpg'),
#   plot = df_nmds2[[2]],
#   width = 8,
#   height = 6
# )
```
```{r}
create_nmds_envfit <- function(df, group_var, nmds_var, taxa_var = 'Taxon', algal_group_var = 'AlgalGroup', factor_var = NULL, show_legend = TRUE, color_palette = NULL, p.max = 0.05, k = 2) {
  set.seed(42)
      
  # Capture symbols
  group_var <- rlang::ensym(group_var)
  nmds_var <- rlang::ensym(nmds_var)
  taxa_var <- rlang::ensym(taxa_var)
  algal_group_var <- rlang::ensym(algal_group_var)
  
  if (!is.null(factor_var)) {
    factor_var <- rlang::ensym(factor_var)
  }
  
  # Prepare the community matrix (Date x Taxon)
  df_cells <- df %>%
    select(!!group_var, !!factor_var, !!taxa_var, !!nmds_var) %>%
    group_by(!!group_var, !!factor_var, !!taxa_var) %>%
    summarise(
      Abundance = mean(.data[[rlang::as_string(nmds_var)]], na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    pivot_wider(names_from = !!taxa_var, values_from = 'Abundance', values_fill = 0)
  
  df_cells <<- df %>%
    select(!!group_var, !!factor_var, !!taxa_var, !!nmds_var) %>%
    group_by(!!group_var, !!factor_var, !!taxa_var) %>%
    summarise(
      Abundance = mean(.data[[rlang::as_string(nmds_var)]], na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    pivot_wider(names_from = !!taxa_var, values_from = 'Abundance', values_fill = 0)
    
  # Extract the main community matrix
  m_com <- df_cells %>%
    select(-!!group_var, -!!factor_var) %>%
    as.matrix()
  
  # Run NMDS
  nmds <- NULL
  invisible(capture.output({
    nmds <- metaMDS(m_com, distance = 'bray', k = k)
  }))
  
  # Extract NMDS scores and preserve factor levels
  df_nmds <- as.data.frame(scores(nmds)$sites) %>%
    mutate(
      Date = df_cells[[rlang::as_string(group_var)]],
      Year = df_cells[[rlang::as_string(factor_var)]]
    ) %>%
    mutate(Year = as.factor(Year))

  # Prepare AlgalGroup matrix (Date x AlgalGroup)
  ag_matrix <- df %>%
    group_by(!!group_var, !!algal_group_var) %>%
    summarise(Abundance = sum(!!nmds_var, na.rm = TRUE), .groups = 'drop') %>%
    pivot_wider(names_from = !!algal_group_var, values_from = 'Abundance', values_fill = 0) %>%
    column_to_rownames(var = rlang::as_string(group_var)) %>%
    as.matrix()
  
  # Ensure row counts match
  if (nrow(df_nmds) != nrow(ag_matrix)) {
    stop("Mismatch between NMDS scores and AlgalGroup data. Check your grouping variables.")
  }
  
  # Run envfit
  envfit_result <- envfit(nmds, ag_matrix, permutations = 999)
  
  # Extract significant vectors
  significant_vectors <- as.data.frame(envfit_result$vectors$arrows) %>%
    rownames_to_column('AlgalGroup') %>%
    mutate(R2 = envfit_result$vectors$r, p_value = envfit_result$vectors$pvals) %>%
    filter(p_value <= p.max)

  # Plot NMDS
  plt_nmds <- ggplot(df_nmds, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(aes(fill = !!factor_var), size = 4, shape = 21, color = 'black') +
    labs(title = paste('NMDS of', as_label(nmds_var), 'by', as_label(group_var))) +
    theme_bw()
  
  if (!is.null(color_palette)) {
    plt_nmds <- plt_nmds + scale_color_manual(values = color_palette)
  }
  
  if (!show_legend) {
    plt_nmds <- plt_nmds + theme(legend.position = 'none')
  }
  
  # Add envfit vectors
  if (nrow(significant_vectors) > 0) {
    plt_nmds <- plt_nmds +
    geom_segment(data = significant_vectors,
                 aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
                 arrow = arrow(length = unit(0.3, 'cm'), type = 'closed'),
                 color = 'darkgray', linewidth = 1) +
      geom_text(data = significant_vectors,
                aes(x = NMDS1, y = NMDS2, label = AlgalGroup), size = 5, nudge_y = 0.05, color = 'black')
  }
    
  return(list(
    df_nmds = df_nmds,
    plot = plt_nmds,
    raw_nmds = nmds,
    envfit = envfit_result
  ))
}

df_nmds_envfit <- create_nmds_envfit(
  df = df_phyto_filtered,
  group_var = 'Date',
  nmds_var = 'Biovolume_per_mL',
  taxa_var = 'Taxon',
  algal_group_var = 'AlgalGroup',
  factor_var = 'Year',
  p.max = 0.05,
  k = 3
)

# Print the NMDS plot
print(df_nmds_envfit$plot)

```

```{r}
df_nmds_envfit <- create_nmds_envfit(
  df = df_phyto_filtered_stationonly,
  group_var = 'Date',
  nmds_var = 'Cells_per_mL',
  taxa_var = 'AlgalGroup',
  algal_group_var = 'AlgalGroup',
  factor_var = 'Year',
  p.max = 0.05,
  k = 2
)

# Print the NMDS plot
print(df_nmds_envfit$plot)
```

```{r}
df_nmds_envfit <- create_nmds_envfit(
  df = df_phyto_filtered,
  group_var = 'Date',
  nmds_var = 'Cells_per_mL',
  taxa_var = 'AlgalGroup',
  algal_group_var = 'AlgalGroup',
  factor_var = 'Year',
  p.max = 0.01,
  k = 3
)

# Print the NMDS plot
print(df_nmds_envfit$plot)
```

```{r}
# Extract NMDS object
nmds_obj <- df_nmds_envfit$raw_nmds

# Extract diagnostics
nmds_stress <- nmds_obj$stress
nmds_stress

Stress = nmds_stress

stressplot(nmds_obj)

# Get Shepard correlation
identical(as.matrix(nmds_obj$diss), as.matrix(vegdist(m_com, method = 'bray')))
```

```{r}
# Extract NMDS object
nmds_obj <- df_nmds_envfit$raw_nmds

# Extract diagnostics
nmds_stress <- nmds_obj$stress
nmds_stress

stressplot(nmds_obj)
```

```{r}
library(goeveg)
m_com <- nmds_obj$call$comm
dimcheck_out <- dimcheckMDS(df_cells[2:length(df_cells)], distance = 'bray', k = 6)
```
```{r}
print(dimcheck_out)
```


```{r}
# Step 1: Define the groups for the three time periods
df_grouped <- df_phyto_filtered %>%
  mutate(Group = case_when(
    Year >= 2016 & Year <= 2018 ~ '2016-2018',
    Year >= 2019 & Year <= 2020 ~ '2019-2020',
    Year >= 2021 & Year <= 2022 ~ '2021-2022',
    TRUE ~ NA_character_
  ))

# Step 2: Normalize the data by the number of years in each group
df_normalized <- df_grouped %>%
  group_by(Group, Taxon) %>%
  summarise(
    Total_Abundance = sum(Cells_per_mL, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  # Calculate Years_in_group based only on the Group
  left_join(
    df_grouped %>%
      group_by(Group) %>%
      summarise(Years_in_group = n_distinct(Year), .groups = 'drop'),
    by = "Group"
  ) %>%
  mutate(Normalized_Abundance = Total_Abundance / Years_in_group)

# Step 3: Calculate the difference in abundance between the three groups
df_comparison <- df_normalized %>%
  spread(Group, Normalized_Abundance) %>%
  replace_na(list(`2016-2018` = 0, `2019-2020` = 0, `2021-2022` = 0)) %>%
  mutate(
    Abundance_Change_1 = `2019-2020` - `2016-2018`,  # Difference between 2019-2020 and 2016-2018
    Abundance_Change_2 = `2021-2022` - `2019-2020`,  # Difference between 2021-2022 and 2019-2020
    Relative_Change_1 = Abundance_Change_1 / `2016-2018`,  # Relative change between 2019-2020 and 2016-2018
    Relative_Change_2 = Abundance_Change_2 / `2019-2020`  # Relative change between 2021-2022 and 2019-2020
  )

# Step 4: Rank taxa by impact considering both changes equally
top_20_taxa <- df_comparison %>%
  # Create a combined score that prioritizes both changes equally
  mutate(
    Combined_Change = abs(Abundance_Change_1) + abs(Abundance_Change_2)  # Combine the absolute changes for both periods
  ) %>%
  arrange(desc(Combined_Change)) %>%  # Rank by the combined change score
  top_n(5, Combined_Change) %>%  # Select the top 20 taxa based on the combined change
  select(Taxon, `2016-2018`, `2019-2020`, `2021-2022`, Abundance_Change_1, Abundance_Change_2, Relative_Change_1, Relative_Change_2)


# Display the top 20 taxa
top_20_taxa

# Display the result
top_20_taxa
```

```{r}
# Step 1: Get the top 20 taxa from the 'top_20_taxa' dataframe
top_20_taxa <- unique(top_20_taxa$Taxon)

# Step 2: Filter df_data to include only the taxa in top_20_taxa
df_filtered <- df_phyto_filtered %>%
  filter(Taxon %in% top_20_taxa)

df_taxon_count <- df_filtered %>%
  group_by(Year, AlgalGroup) %>%
  summarise(Unique_Taxon_Count = n_distinct(Taxon), .groups = 'drop')

# Step 2: Pivot the data to have Years as columns
df_taxon_count_wide <- df_taxon_count %>%
  pivot_wider(names_from = Year, values_from = Unique_Taxon_Count, values_fill = list(Unique_Taxon_Count = 0))

# Display the result
df_taxon_count_wide

df_filtered <- df_filtered %>%
  mutate(Taxon_AlgalGroup = paste(Taxon, "\n", AlgalGroup))

# Step 3: Summarize the abundance by Taxon and Year
df_summary <- df_filtered %>%
  group_by(Year, Taxon_AlgalGroup) %>%
  summarise(Sum_Abundance = sum(Cells_per_mL, na.rm = TRUE), .groups = 'drop')

# Step 4: Create the bar chart
# Create the plot with combined legend for Taxon and AlgalGroup
ggplot(df_summary, aes(x = Year, y = Sum_Abundance, color = Taxon_AlgalGroup, group = Taxon_AlgalGroup)) +
  geom_point(size = 3) +  # Plot points
  geom_line() +  # Connect points with lines
  labs(x = "Year",
       y = "Total Abundance",
       color = "Taxon and Algal Group") +  # Custom legend title
  theme_minimal() +
  facet_wrap(~ Taxon_AlgalGroup, scales = 'free_y') +
  theme(legend.position = 'none')
```

