# Check BGC data

**Purpose:** Code to check BP data for errors

**Author:** Perry ([sarah.perry\@water.ca.gov](mailto:sarah.perry@water.ca.gov){.email})

```{r}
library(tidyverse)
library(vegan)
library(lubridate)
source('admin/global_functions/global_funcs.R')
source('admin/global_functions/check_funcs.R')
```

```{r}
load('synthesized/02_group_data/USGS-BGC.RData')

# format main dataframe (species unit)
df_phyto <- df_bgc %>%
  mutate(Year = as.factor(year(Date)),
         Binary = 1,
         Event = paste(Date, Station, sep = '_'))


df_phyto <- df_phyto %>%
  mutate(
    Year = as.integer(as.character(Year)),
    YearGroup = case_when(
      Year < 2019 ~ 'first',
      TRUE ~ 'second'
    ),
    Year = as.factor(Year)
  )

# format df (genus unit)
df_genus <- df_phyto %>%
  group_by(Date, Year, Station, Genus, SampleMethod, Event, YearGroup) %>%
  summarize(Biovolume_per_mL = sum(Biovolume_per_mL),
            Cells_per_mL = sum(Cells_per_mL),
            .groups = 'drop') %>%
  mutate(Binary = 1)
```

# NMDS by Species and Event

## Biovol
```{r}
# create NMDS
df_bv <- calc_nmds(df_phyto,
                   group_var = 'Event',
                   factor_var = c('YearGroup','Year','SampleMethod'),
                   nmds_var = 'Biovolume_per_mL',
                   try = 5, trymax = 5)

# print plot
plt_nmds <- plot_nmds(df_bv$df_nmds, df_bv$meta_vars, fill_var = 'Year')
plt_nmds

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Species_Biovol_Year.jpg'),
  plot = plt_nmds,
  width = 8,
  height = 6
)

# print plot
plt_nmds <- plot_nmds(df_bv$df_nmds, df_bv$meta_vars, fill_var = 'SampleMethod')
plt_nmds

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Species_Biovol_SampMethod.jpg'),
  plot = plt_nmds,
  width = 8,
  height = 6
)
```

### Check
Check that there isn't a data quality issue explaining the two groups (2016-2018 and 2019-2022)

```{r}
# create simper index
sim <- simper(df_bv$m_com, group = df_bv$df_nmds$YearGroup, permutations = 100)
head(summary(sim)[[1]], 10)

# plot
plt_simper <- plot_simper_bp(df_phyto, sim, taxon_col = 'Taxon', y_axis = 'Biovolume_per_mL')
plt_simper

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_SIMPER_Species_Biovol.jpg'),
  plot = plt_simper,
  width = 8,
  height = 6
)
```

## Cells
```{r}
# create NMDS
df_cell <- calc_nmds(df_phyto,
                     group_var = 'Event',
                     factor_var = c('Year','SampleMethod'),
                     nmds_var = 'Cells_per_mL',
                     try = 5, trymax = 5)

# print plot
plt_nmds <- plot_nmds(df_cell$df_nmds, df_cell$meta_vars, fill_var = 'Year')
plt_nmds

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Species_Cells_Year.jpg'),
  plot = plt_nmds,
  width = 8,
  height = 6
)

# print plot
plt_nmds <- plot_nmds(df_cell$df_nmds, df_cell$meta_vars, fill_var = 'SampleMethod')
plt_nmds

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Species_Cells_SampMethod.jpg'),
  plot = plt_nmds,
  width = 8,
  height = 6
)
```

## PA
```{r}
# create NMDS
df_pa <- calc_nmds(df_phyto,
                   group_var = 'Event',
                   factor_var = c('Year','YearGroup','SampleMethod'),
                   nmds_var = 'Binary',
                   distance = 'jaccard',
                   try = 5, trymax = 5)

# print plot
plt_nmds <- plot_nmds(df_pa$df_nmds, df_pa$meta_vars, fill_var = 'Year')
plt_nmds

# ggsave(
#   filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Species_PA_Year.jpg'),
#   plot = plt_nmds,
#   width = 8,
#   height = 6
# )

# print plot
plt_nmds <- plot_nmds(df_pa$df_nmds, df_pa$meta_vars, fill_var = 'SampleMethod')
plt_nmds

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Species_PA_SampMethod.jpg'),
  plot = plt_nmds,
  width = 8,
  height = 6
)
```

### Check
Check that there isn't a data quality issue explaining the two groups (2016-2018 and 2019-2022)

```{r}
# create simper index
sim <- simper(df_pa$m_com, group = df_pa$df_nmds$YearGroup, permutations = 100)
head(summary(sim)[[1]], 10)

# plot
plt_simper <- plot_simper_summary(df_phyto, sim, taxon_col = 'Taxon', x_axis = 'Year', y_axis = 'Binary')
plt_simper

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_SIMPER_Species_PA.jpg'),
  plot = plt_simper,
  width = 8,
  height = 6
)
```


# NMDS by Genus and Event

## Biovol
```{r}
# create NMDS
df_bv <- calc_nmds(df_genus,
                   taxa_var = 'Genus',                    
                   group_var = 'Event',
                   factor_var = c('Year','YearGroup','SampleMethod'),
                   nmds_var = 'Biovolume_per_mL',
                   try = 5, trymax = 5)

# print plot
plt_nmds <- plot_nmds(df_bv$df_nmds, df_bv$meta_vars, fill_var = 'Year')
plt_nmds

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Genus_Biovol_Year.jpg'),
  plot = plt_nmds,
  width = 8,
  height = 6
)

# print plot
plt_nmds <- plot_nmds(df_bv$df_nmds, df_bv$meta_vars, fill_var = 'SampleMethod')
plt_nmds

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Genus_Biovol_SampMethod.jpg'),
  plot = plt_nmds,
  width = 8,
  height = 6
)
```

### Check
Check that there isn't a data quality issue explaining the two groups (2016-2018 and 2019-2022)

```{r}
# create simper index
sim <- simper(df_bv$m_com, group = df_bv$df_nmds$YearGroup, permutations = 100)
head(summary(sim)[[1]], 10)

# plot
plt_simper <- plot_simper_bp(df_phyto, sim, taxon_col = 'Genus', y_axis = 'Biovolume_per_mL')
plt_simper

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_SIMPER_Genus_Biovol.jpg'),
  plot = plt_simper,
  width = 8,
  height = 6
)
```

## Cells
```{r}
# create NMDS
df_cell <- calc_nmds(df_genus,
                     taxa_var = 'Genus',                    
                     group_var = 'Event',
                     factor_var = c('Year','SampleMethod'),
                     nmds_var = 'Cells_per_mL',
                     try = 5, trymax = 5)

# print plot
plt_nmds <- plot_nmds(df_cell$df_nmds, df_cell$meta_vars, fill_var = 'Year')
plt_nmds

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Genus_Cells_Year.jpg'),
  plot = plt_nmds,
  width = 8,
  height = 6
)

# print plot
plt_nmds <- plot_nmds(df_cell$df_nmds, df_cell$meta_vars, fill_var = 'SampleMethod')
plt_nmds

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Genus_Cells_SampMethod.jpg'),
  plot = plt_nmds,
  width = 8,
  height = 6
)
```

## PA
```{r}
# create NMDS
df_pa <- calc_nmds(df_genus,
                   taxa_var = 'Genus',                    
                   group_var = 'Event',
                   factor_var = c('Year','YearGroup','SampleMethod'),
                   nmds_var = 'Binary',
                   distance = 'jaccard',
                   try = 5, trymax = 5)

# print plot
plt_nmds <- plot_nmds(df_pa$df_nmds, df_pa$meta_vars, fill_var = 'Year')
plt_nmds

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Genus_PA_Year.jpg'),
  plot = plt_nmds,
  width = 8,
  height = 6
)

# print plot
plt_nmds <- plot_nmds(df_pa$df_nmds, df_pa$meta_vars, fill_var = 'SampleMethod')
plt_nmds

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_Genus_PA_SampMethod.jpg'),
  plot = plt_nmds,
  width = 8,
  height = 6
)
```

### Check
Check that there isn't a data quality issue explaining the two groups (2016-2018 and 2019-2022)

```{r}
# create simper index
sim <- simper(df_pa$m_com, group = df_pa$df_nmds$YearGroup, permutations = 100)
head(summary(sim)[[1]], 10)

# plot
plt_simper <- plot_simper_summary(df_phyto, sim, taxon_col = 'Genus', x_axis = 'Year', y_axis = 'Binary')
plt_simper

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_SIMPER_Genus_PA.jpg'),
  plot = plt_simper,
  width = 8,
  height = 6
)
```

# Check Counts
```{r}
plt_count <- check_station_count(df_phyto)

plt_count

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_HM_StationNumber.jpg'),
  plot = plt_count,
  width = 8,
  height = 5
)
```

```{r}
df_phyto <- df_phyto %>%
  rename(Station2 = Station,
         Station = Location)

plt_freq <- check_sampling_freq(df_phyto)

plt_freq

ggsave(
  filename = abs_pesp_path('Synthesized Dataset/01 Group Checks/USGS-BGC/graphs/BGC-Synth_HM_SampFreq.jpg'),
  plot = plt_freq,
  width = 8,
  height = 10
)
```