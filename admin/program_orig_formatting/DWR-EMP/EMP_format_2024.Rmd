# Format 2024 EMP data

**Purpose:** Code to format EMP data for original PESP upload.

**Author:** Perry ([sarah.perry\@water.ca.gov](mailto:sarah.perry@water.ca.gov){.email})

# Initial setup

```{r, message=FALSE, warning=FALSE}
# import packages
devtools::load_all()
```

## Read in data

```{r}
# specify the file path
data_path <- abs_pesp_path('Groups/DWR-EMP/01 Raw Data/All 2024 Data.csv')

# new data to format and append
df_data <- read_quiet_csv(data_path)
```

## Check distinct columns

```{r}
df_data <- check_distinct(df_data, type = 'full')
nondistinct_rows <- attr(df_data, 'log')$nondistinct_allrows

if (!is.null(nondistinct_rows)) {
 write_log_file(nondistinct_rows, 'Groups/DWR-EMP/02 Program Data/QC files/2024/tables/EMP_nondistinct_rows.csv')
}

# remove duplicates
df_data <- df_data %>% distinct()

print(nondistinct_rows)

check_distinct(df_data, type = 'full')
```

## Rename columns
```{r}
colnames(df_data)
```


```{r}
rename_map <- c(
  'Station' = 'StationCode',
  'Date' = 'SampleDate',
  'Time' = 'SampleTime',
  'PhytoForm' = 'Colony/Filament/Individual Group Code',
  'GALD' = 'GALD 1',
  'Unit Abundance' = 'Unit Abundance (# of Natural Units)',
  'CountMethod' = 'Count Method',
  'SlideChamberArea' = 'Slide/ Chamber Area (mm²)',
  'FoV' = 'Field-of-view (mm²)'
)

df_data <- rename_cols(df_data, rename_map)
```

## Remove old taxa info

```{r}
df_data <- remove_taxa_info(df_data)
```

## Calculate measurement columns

```{r}
# dependent on if lab is BSA or EA
df_data <- calc_data_bsa(df_data)
```
## Clean PhytoForm column

```{r}
df_data <- clean_phytoform_bsa(df_data)
```

## Fix Date/Time; add lat/lon

```{r}
df_data$Date <- as.Date(df_data$Date,'%m/%d/%Y')

# remove Times
# df_data <- df_data %>% select(-Time)
```

### Read in WQ data (for Dates/Times/Lats/Lons)
### TODO after WQ gets sorted

<!-- ```{r} -->
<!-- # read in WQ data -->
<!-- fp_wq <- abs_pesp_path('Groups/DWR-EMP/01 Raw Data/EMP_DWQ_2024_formatted.csv') -->

<!-- df_wq <- read_quiet_csv(fp_wq) -->

<!-- df_wq <- df_wq %>% -->
<!--   separate(`Sample Date`, into = c('Date', 'Time'), sep = ' ', remove = TRUE) %>% -->
<!--   mutate(Date = mdy(Date)) %>% -->
<!--   rename(Station = `Station Name`) -->
<!-- ``` -->

<!-- ### Fix Dates -->
<!-- ```{r} -->
<!-- # read the fixed date mappings -->
<!-- fp_dates <- abs_pesp_path('Groups/DWR-EMP/01 Raw Data/mismatched_phyto_wq_dates.csv') -->

<!-- df_fixed_dates <- read_quiet_csv(fp_dates,  col_types = cols(Station = col_character(), -->
<!--                                                              PhytoDate = col_date(format = '%m/%d/%Y'), -->
<!--                                                              WQDate = col_date(format = '%m/%d/%Y') -->
<!--                                                              )) -->

<!-- # update date/times -->
<!-- df_data <- update_dates_emp(df_data, df_fixed_dates) -->
<!-- fixed_dates <- attr(df_data, 'log')$fixed_dates -->
<!-- write_log_file(fixed_dates, 'Groups/DWR-EMP/02 Program Data/QC files/2024/tables/EMP_fixed_dates.csv') -->
<!-- ``` -->

<!-- ### Add lat/lons/times -->
<!-- ```{r} -->
<!-- # join WQ data (add times and lat/lon for EZ stations) -->
<!-- df_data <- add_wq_emp(df_data, df_wq) -->
<!-- missing_wq <- attr(df_data, 'log')$missing_wq -->
<!-- write_log_file(missing_wq, 'Groups/DWR-EMP/02 Program Data/QC files/2024/tables/EMP_missing_wq.csv') -->
<!-- ``` -->

```{r}
# add lat/lon for fixed stations
df_data <- add_latlon(df_data, 'Groups/DWR-EMP/Metadata/Stations-EMP.csv', merge_cols = c('Location','Station','Latitude','Longitude'))
```

## Add metadata columns

```{r}
df_data <- add_meta_col(df_data, 'DWR-EMP', 'Lab')

# Update count method w/ half-chamber scan
df_data <- df_data %>%
  mutate(CountMethod = 
           case_when(
             round(FoV) == round(SlideChamberArea/2) ~ 'HalfChamber',
             TRUE ~ CountMethod
           )
         )
```

# Add Taxonomy (and QC column)

## Standardize unknowns

```{r}
df_data <- clean_unknowns(df_data, std_sp = TRUE, std_suffix = TRUE)
standardized_unknowns <- attr(df_data, 'log')$clean_unknowns
write_log_file(standardized_unknowns, 'Groups/DWR-EMP/02 Program Data/QC files/2024/tables/EMP_standardized_unknowns.csv')

print(standardized_unknowns)
```

## Correct typos

```{r}
df_data <- correct_taxon_typos(df_data)
corrected_typos <- attr(df_data, 'log')$taxon_corrections
write_log_file(corrected_typos, 'Groups/DWR-EMP/02 Program Data/QC files/2024/tables/EMP_corrected_typos.csv')

print(corrected_typos)
```

## Add QC column

```{r}
df_data <- add_qc_col(df_data)
df_data <- add_debris_col(df_data)
df_data <- add_notes_col(df_data)

df_data <- extract_unstandardized_comments(df_data, 'Comments', delimiter = '. ')
unmatched_comments <- attr(df_data, 'log')$unmatched_comments
write_log_file(unmatched_comments, 'Groups/DWR-EMP/02 Program Data/QC files/2024/tables/EMP_leftover_comments.csv')

print(unmatched_comments)
```

## Update synonyms

```{r}
df_data <- update_synonyms(df_data)
updated_synonyms <- attr(df_data, 'log')$synonym_updates
write_log_file(updated_synonyms, 'Groups/DWR-EMP/02 Program Data/QC files/2024/tables/EMP_updated_synonyms.csv')

print(updated_synonyms)
```

## Add in higher-level taxa

```{r}
df_data <- higher_lvl_taxa(df_data, std_type = 'program')
needs_hierarchy <- attr(df_data, 'log')$unmatched_taxa
write_log_file(needs_hierarchy, 'Groups/DWR-EMP/02 Program Data/QC files/2024/tables/EMP_needs_hierarchy.csv')

print(needs_hierarchy)
```

## Check distinct cols before combining

```{r}
df_data <- check_distinct(df_data, type = 'full')
attr(df_data, 'log')$nondistinct_allrows

df_data <- check_distinct(df_data, type = 'key_cols')
attr(df_data, 'log')$nondistinct_keyrows
```

## Subset columns

```{r}
df_data <- subset_cols_emp(df_data)
```

## Combine taxa (multiple sizes, standardized unknowns)

```{r}
df_data <- combine_taxons(df_data, key_cols = c('Date','Station','CountMethod'))
combined_taxa <- attr(df_data, 'log')$combined_taxa
write_log_file(combined_taxa, 'Groups/DWR-EMP/02 Program Data/QC files/2024/tables/EMP_combined_taxa.csv')

print(combined_taxa)
```

# Finish Formatting

# Checks

```{r}
# check for NAs
df_data <- check_nas(df_data)
na_check <- attr(df_data, 'log')$na_check

print(na_check)
```

```{r}
unique_check(df_data, 'Station')
```

```{r}
# set <measurements> == 0 to NA (have to do later in code)
df_data <- df_data %>%
  mutate(
    Cells_per_mL = case_when(Cells_per_mL == 0 ~ NA,
                                      TRUE ~ Cells_per_mL),
    Units_per_mL = case_when(Units_per_mL == 0 ~ NA,
                                      TRUE ~ Units_per_mL),
    Biovolume_per_mL = case_when(Biovolume_per_mL == 0 ~ NA,
                                      TRUE ~ Biovolume_per_mL)
    )
```

# Merge with Old Data

```{r}
# old data
df_old <- read_quiet_csv(abs_pesp_path('Groups/DWR-EMP/02 Program Data/EMP_program_draft_2008-2023.csv'))

df_join <- full_join(df_old, df_data)

nrow(df_join) == nrow(df_old)+nrow(df_data)

df_join <- df_join %>%
  arrange(Date, Time, Location)
```

# Export

```{r}
write_csv(df_join, abs_pesp_path('Groups/DWR-EMP/02 Program Data/EMP_program_draft_2008-2024.csv'))
```
