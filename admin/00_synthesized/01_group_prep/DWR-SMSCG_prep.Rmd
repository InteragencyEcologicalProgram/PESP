# Prep SMSCG Data

**Purpose:** Prep SMSCG data for PESP merge.

**Author:** Perry ([sarah.perry\@water.ca.gov](mailto:sarah.perry@water.ca.gov){.email})

# Initial Setup

```{r, message=FALSE, warning=FALSE}
# Import Packages ---------------------------------------------------------
library(tidyverse)
library(fuzzyjoin)
library(glue)
library(lubridate)

source('admin/global_functions/global_funcs.R')
source('admin/global_functions/syn_funcs.R')
source('admin/global_functions/bsa_funcs.R')
source('admin/global_functions/check_funcs.R')
```

# Read in data

```{r}
# specify the file path
data_path_smscg <- abs_pesp_path('Groups/DWR-SMSCG/02 Program Data/SMSCG_phytoplankton_samples_2020-2023.csv')

# new data to format and append
df_smscg <- read_quiet_csv(data_path_smscg)
```

# Clean data

## Rename columns

```{r}
rename_map <- c(
  'Taxon' = 'taxon',
  'OrigTaxon' = 'taxon_original',
  'Station' = 'station',
  'Date' = 'date',
  'Latitude' = 'latitude',
  'Longitude' = 'longitude',
  'Time' = 'time_pst',
  'GALD' = 'gald_um',
  'PhytoForm' = 'phyto_form',
  'Cells_per_mL' = 'cells_per_ml',
  'Units_per_mL' = 'units_per_ml',
  'Biovolume_per_mL' = 'biovolume_per_ml',
  'QualityCheck' = 'quality_check',
  'Debris' = 'debris'
)

df_smscg <- rename_cols(df_smscg, rename_map)

# pull original taxon for taxon column
df_smscg <- extract_program_taxons(df_smscg)

# note: time is already in PST
```

## Remove EMP Samples

```{r}
df_smscg <- df_smscg %>%
  filter(!str_detect(Station, 'EMP_'))
```

## Add in Metadata

```{r}
# Survey
df_smscg <- df_smscg %>% mutate(Survey = collected_by)

# Magnification
df_smscg <- add_meta_col(df_smscg, 'DWR-SMSCG', 'Magnification')

# Sample Scheme
df_smscg <- add_meta_col(df_smscg, 'DWR-SMSCG', 'SampleScheme')

# Sample Method
df_smscg <- add_meta_col(df_smscg, 'DWR-SMSCG', 'SampleMethod')

# Depth Type
df_smscg <- add_meta_col(df_smscg, 'DWR-SMSCG', 'DepthType')

# Sample Depth
df_smscg <- add_meta_col(df_smscg, 'DWR-SMSCG', 'SampleDepth')

#Lab
df_smscg <- add_meta_col(df_smscg, 'DWR-SMSCG', 'Lab')

# Notes
df_smscg <- df_smscg %>% mutate(Notes = 'Unknown')

# Count Method
df_smscg <- add_meta_col(df_smscg, 'DWR-SMSCG', 'CountMethodSample')

df_smscg <- df_smscg %>%
  mutate(CountMethodTaxa = CountMethodSample) # must be the same

# Location
df_smscg <- df_smscg %>%
  mutate(Location = Station) # same for this study
```

## Add extra columns

```{r}
df_smscg <- df_smscg %>% 
  mutate(TowNetRadius = NA,
         OrigTaxon = Taxon)
```

## Remove old taxa info

```{r}
df_smscg <- remove_taxa_info(df_smscg)
```

## Add PESP Taxon

## Correct typos
```{r}
df_smscg <- correct_taxon_typos(df_smscg)
corrected_typos <- attr(df_smscg, 'log')$taxon_corrections
write_log_file(corrected_typos, 'Synthesized Dataset/01 Group Checks/DWR-SMSCG/tables/SMSCG_corrected_typos.csv')

print(corrected_typos)
```

## Standardize unknowns
```{r}
df_smscg <- clean_unknowns(df_smscg, std_sp = TRUE, std_suffix = TRUE)
standardized_unknowns <- attr(df_smscg, 'log')$clean_unknowns
write_log_file(standardized_unknowns, 'Synthesized Dataset/01 Group Checks/DWR-SMSCG/tables/SMSCG_standardized_unknowns.csv')

print(standardized_unknowns)
```

## Update synonyms
```{r}
df_smscg <- update_synonyms(df_smscg)
updated_synonyms <- attr(df_smscg, 'log')$synonym_updates
write_log_file(updated_synonyms, 'Synthesized Dataset/01 Group Checks/DWR-SMSCG/tables/SMSCG_updated_synonyms.csv')

print(updated_synonyms)
```

## Add in higher-level taxa

```{r}
df_smscg <- higher_lvl_taxa(df_smscg, std_type = 'PESP')
needs_hierarchy <- attr(df_smscg, 'log')$unmatched_taxa

print(needs_hierarchy)
```
## Add ID column
```{r}
df_smscg <- add_id_col(df_smscg, loc_col = 'Station')
```

## Subset relevant columns
```{r}
df_smscg <- subset_cols(df_smscg)

df_smscg <- df_smscg %>%
  arrange(Date, Time) %>%
  mutate(
    Cells_per_mL = round(Cells_per_mL, 2),
    Units_per_mL = round(Units_per_mL, 2),
    Biovolume_per_mL = round(Biovolume_per_mL, 2)
  )
```

## Remove prefix in Station

```{r}
df_smscg <- df_smscg %>%
  mutate(Station = str_replace(Station, '^[^_]+_', ''))
```

# Rename QC col codes
```{r}
df_smscg <- df_smscg %>%
  mutate(Notes =
           case_when(QualityCheck == 'fragmented' ~ 'FragmentedDiatoms',
                     TRUE ~ 'Unknown')
         ) %>%
  mutate(QualityCheck =
           case_when(QualityCheck == 'good' ~ 'NoCode',
                     QualityCheck == 'fragmented' ~ 'NoCode',
                     QualityCheck == 'degraded' ~ 'Degraded',
                     TRUE ~ QualityCheck)
         ) %>%
  mutate(Debris =
           case_when(Debris == 'high' ~ 'High',
                     Debris == 'moderate' ~ 'Moderate',
                     Debris == 'low' ~ 'Low',
                     is.na(Debris) ~ 'None',
                     TRUE ~ Debris))

unique(df_smscg$Debris)
unique(df_smscg$Notes)
unique(df_smscg$QualityCheck)
```

## Combine taxa (multiple sizes, standardized unknowns)
```{r}
df_smscg <- combine_taxons(df_smscg, key_cols = c('Date', 'Time', 'Station', 'SampleDepth'))
combine_issues <- attr(df_smscg, 'log')$combined_conflicts
combine_checks <- attr(df_smscg, 'log')$combined_taxa
```

# Save .Rdata

```{r}
save(df_smscg, file = 'synthesized/02_group_data/DWR-SMSCG.Rdata')
```
