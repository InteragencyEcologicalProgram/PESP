# Prep BP Data

**Purpose:** Prep BP data for PESP merge.

**Author:** Perry ([sarah.perry\@water.ca.gov](mailto:sarah.perry@water.ca.gov){.email})

# Initial setup
```{r, message=FALSE, warning=FALSE}
# import packages
devtools::load_all()
```

# Read in data
```{r}
# specify the file path
data_path_bp <- abs_pesp_path('Groups/USGS-BP/02 Program Data/BP_program_draft.csv')

# new data to format and append
df_bp <- read_quiet_csv(data_path_bp)
```

# Clean data

## Add in Metadata
```{r}
# Survey
df_bp <- add_meta_col(df_bp, 'USGS-BP', 'Survey')

# Magnification
df_bp <- add_meta_col(df_bp, 'USGS-BP', 'Magnification', match_cols = 'SampleMethod')

# Depth Type
df_bp <- df_bp %>% mutate(DepthType = 
                            case_when(Depth_m <= 2 ~ 'near surface',
                                      Depth_m > 2 ~ 'mid-depth'))

# Sample Scheme
df_bp <- add_meta_col(df_bp, 'USGS-BP', 'SampleScheme', match_cols = 'SampleMethod')

# Count Method
df_bp <- add_meta_col(df_bp, 'USGS-BP', 'CountMethodSample', match_cols = 'SampleMethod')

df_bp <- df_bp %>%
  mutate(CountMethodTaxa = CountMethodSample)
```

## Add extra columns
```{r}
df_bp <- df_bp %>% 
  rename(TowNetRadius = NetRadius_cm,
         SampleDepth = Depth_m) %>%
  mutate(Time = NA,
         Units_per_mL = NA,
         Location = Station,
         GALD = NA,
         PhytoForm = NA)
```

## Format PESP Taxon
## Extract Taxon
```{r}
df_bp <- extract_program_taxa(df_bp)
```

## Correct typos
```{r}
df_bp <- correct_taxon_typos(df_bp)
corrected_typos <- attr(df_bp, 'log')$taxon_corrections
write_log_file(corrected_typos, 'Synthesized Dataset/01 Group Checks/USGS-BP/tables/BP_corrected_typos.csv')

print(corrected_typos)
```

### Standardize unknowns
```{r}
df_bp <- clean_unknowns(df_bp, std_sp = TRUE, std_suffix = TRUE)
standardized_unknowns <- attr(df_bp, 'log')$clean_unknowns
write_log_file(standardized_unknowns, 'Synthesized Dataset/01 Group Checks/USGS-BP/tables/BP_standardized_unknowns.csv')

print(standardized_unknowns)
```

### Update synonyms
```{r}
df_bp <- update_synonyms(df_bp)
updated_synonyms <- attr(df_bp, 'log')$synonym_updates
write_log_file(updated_synonyms, 'Synthesized Dataset/01 Group Checks/USGS-BP/tables/BP_updated_synonyms.csv')
print(updated_synonyms)
```

### Add in higher-level taxa
```{r}
df_bp <- higher_lvl_taxa(df_bp, std_type = 'PESP')
needs_hierarchy <- attr(df_bp, 'log')$unmatched_taxa

print(needs_hierarchy)
```

## Add ID column
```{r}
df_bp <- add_id_col(df_bp, loc_col = 'Station')
```

## Subset relevant columns
```{r}
df_bp <- subset_cols(df_bp)
```

## Combine taxa (multiple sizes, standardized unknowns)
```{r}
df_bp <- combine_taxa(df_bp, key_cols = c('Station','Date','SampleDepth','Lab','SampleMethod'), measurement_cols = c('Biovolume_per_mL','Cells_per_mL'))
combine_issues <- attr(df_bp, 'log')$combined_conflicts
combine_checks <- attr(df_bp, 'log')$combined_taxa
```

## Save .Rdata
```{r}
save(df_bp, file = 'admin/standardized_data/USGS-BP.Rda')
```
