% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/global_funcs.R
\name{combine_taxa}
\alias{combine_taxa}
\title{Combine taxa records}
\usage{
combine_taxa(
  df,
  key_cols = c("Date", "Station"),
  measurement_cols = c("Biovolume_per_mL", "Units_per_mL", "Cells_per_mL")
)
}
\arguments{
\item{df}{A dataframe containing taxonomic records with at least the columns
\code{Date}, \code{Station}, and \code{Taxon}. Optional columns such as \code{Notes}, \code{QualityCheck},
\code{Debris}, \code{PhytoForm}, \code{GALD}, and \code{OrigTaxon} are processed if present.}

\item{key_cols}{Character vector specifying the columns defining an event group.
Default is \code{c("Date", "Station")}.}

\item{measurement_cols}{Character vector of numeric columns to sum within each group.
Default is \code{c("Biovolume_per_mL", "Units_per_mL", "Cells_per_mL")}.}
}
\value{
A dataframe where duplicate or size-variant taxon rows within a sampling event
are aggregated into a single record:
\itemize{
\item Numeric measurement columns are summed
\item Text descriptors are merged intelligently
\item Higher-level mismatches are labeled as \code{"Unknown <level>"}
}

The returned dataframe includes a \code{log} attribute containing:
\itemize{
\item \strong{$combined_taxa} — a dataframe listing the groups that were merged
\item \strong{$combined_conflicts} — a dataframe of columns with multiple distinct values within a group
}
}
\description{
Aggregates multiple taxon records within the same sampling event (based on \code{key_cols}) that
differ only by size class, label formatting, or represent duplicate entries.

Density and count fields are summed, while qualitative fields such as \code{Notes},
\code{QualityCheck}, and \code{Debris} are merged intelligently to retain relevant detail.
\itemize{
\item If multiple distinct \code{OrigTaxon} values occur within a group, they are concatenated
into a single semicolon-separated string. When all \code{OrigTaxon} entries are missing,
the resulting \code{OrigTaxon} is set to \code{NA}.
\item If higher-level classification fields disagree within a sampling event, the \code{Taxon} name is replaced with \code{"Unknown <level>"},
(e.g. \code{"Unknown class"}). Each distinct \verb{Unknown <level>} becomes a separate record.
\item Only one row per unique sampling event + taxon is retained after aggregation.
\item A log of all combined taxa and column conflicts is attached as a dataframe attribute.
}
}
\details{
Aggregation rules:
\itemize{
\item \strong{Notes} — unique non-\code{"NoNote"} values are combined; \code{"MultipleEntries"} appended only
when multiple rows were merged (\code{.n_in_group > 1})
\item \strong{QualityCheck} — unique non-\code{"NoCode"} values combined (no extra flags)
\item \strong{Debris} — ordered by category (\verb{High > Moderate > Low > None > Unknown})
\item \strong{PhytoForm} — unique forms combined alphabetically
\item \strong{GALD} — maximum non-missing value is retained
\item \strong{OrigTaxon} — concatenated with \code{"; "} if multiple distinct values exist;
remains \code{NA} if all source values were missing
}
}
